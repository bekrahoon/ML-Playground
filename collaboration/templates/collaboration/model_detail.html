{% extends 'base.html' %}

{% block title %}{{ public_model.title }} - ML Playground{% endblock %}

{% block extra_css %}
<style>
.like-button {
    cursor: pointer;
    transition: all 0.3s;
}
.like-button.liked {
    color: #dc3545 !important;
}
</style>
{% endblock %}

{% block content %}
<div class="mb-4">
    <a href="{% url 'collaboration:model_list' %}" class="btn btn-outline-secondary mb-3">
        <i class="bi bi-arrow-left"></i> Назад к моделям
    </a>
    
    <h2>{{ public_model.title }}</h2>
    <p class="text-muted">
        <i class="bi bi-person"></i> {{ public_model.author.username }} •
        <i class="bi bi-calendar"></i> {{ public_model.created_at|date:"d.m.Y" }}
    </p>
</div>

<!-- Статистика и действия -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-center">
            <div class="col-md-6">
                <div class="d-flex gap-4">
                    <div>
                        <i class="bi bi-heart"></i>
                        <strong id="likes-count">{{ public_model.likes_count }}</strong> лайков
                    </div>
                    <div>
                        <i class="bi bi-eye"></i>
                        <strong>{{ public_model.views_count }}</strong> просмотров
                    </div>
                    <div>
                        <i class="bi bi-download"></i>
                        <strong>{{ public_model.downloads_count }}</strong> скачиваний
                    </div>
                    <div>
                        <i class="bi bi-chat"></i>
                        <strong>{{ comments|length }}</strong> комментариев
                    </div>
                </div>
            </div>
            <div class="col-md-6 text-end">
                {% if user.is_authenticated %}
                    <button type="button" 
                            class="btn btn-outline-danger like-button {% if user_liked %}liked{% endif %}" 
                            id="like-btn"
                            data-model-id="{{ public_model.pk }}">
                        <i class="bi bi-heart{% if user_liked %}-fill{% endif %}"></i>
                        <span id="like-text">{% if user_liked %}Убрать лайк{% else %}Лайк{% endif %}</span>
                    </button>
                    <a href="{% url 'collaboration:fork_model' public_model.pk %}" 
                       class="btn btn-primary">
                        <i class="bi bi-box-arrow-down"></i> Скопировать себе
                    </a>
                {% else %}
                    <a href="{% url 'accounts:login' %}" class="btn btn-outline-secondary">
                        Войдите, чтобы лайкнуть
                    </a>
                {% endif %}
                
                {% if user == public_model.author %}
                    <a href="{% url 'collaboration:unpublish_model' public_model.pk %}" 
                       class="btn btn-outline-danger">
                        <i class="bi bi-trash"></i> Снять с публикации
                    </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Информация о модели -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Описание</h5>
            </div>
            <div class="card-body">
                <p style="white-space: pre-wrap;">{{ public_model.description }}</p>
                
                {% if public_model.use_cases %}
                    <hr>
                    <h6>Примеры использования:</h6>
                    <p style="white-space: pre-wrap;">{{ public_model.use_cases }}</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Метрики модели -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">Метрики производительности</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    {% if original_model.accuracy %}
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <h6>Accuracy</h6>
                                <h3 class="text-success">{{ original_model.accuracy|floatformat:4 }}</h3>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if original_model.f1_score %}
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <h6>F1 Score</h6>
                                <h3 class="text-success">{{ original_model.f1_score|floatformat:4 }}</h3>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if original_model.r2_score %}
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <h6>R² Score</h6>
                                <h3 class="text-primary">{{ original_model.r2_score|floatformat:4 }}</h3>
                            </div>
                        </div>
                    {% endif %}
                    
                    {% if original_model.rmse %}
                        <div class="col-md-3 mb-3">
                            <div class="text-center">
                                <h6>RMSE</h6>
                                <h3 class="text-info">{{ original_model.rmse|floatformat:4 }}</h3>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- Комментарии -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-chat"></i> Комментарии ({{ comments|length }})
                </h5>
            </div>
            <div class="card-body">
                {% if user.is_authenticated %}
                    <form method="post" action="{% url 'collaboration:add_comment' public_model.pk %}">
                        {% csrf_token %}
                        {{ comment_form.text }}
                        <button type="submit" class="btn btn-primary mt-2">
                            <i class="bi bi-send"></i> Отправить
                        </button>
                    </form>
                    <hr>
                {% else %}
                    <p class="text-muted">
                        <a href="{% url 'accounts:login' %}">Войдите</a>, чтобы оставить комментарий
                    </p>
                    <hr>
                {% endif %}
                
                {% for comment in comments %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <strong>{{ comment.author.username }}</strong>
                            <small class="text-muted">
                                {{ comment.created_at|date:"d.m.Y H:i" }}
                            </small>
                        </div>
                        <p class="mb-0">{{ comment.text }}</p>
                    </div>
                    {% if not forloop.last %}<hr>{% endif %}
                {% empty %}
                    <p class="text-muted text-center">Пока нет комментариев. Будьте первым!</p>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Боковая панель -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Детали модели</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <strong>Алгоритм:</strong><br>
                    <span class="badge bg-primary">
                        {{ original_model.get_algorithm_display }}
                    </span>
                </div>
                
                <div class="mb-3">
                    <strong>Датасет:</strong><br>
                    {{ original_model.dataset.name }}
                </div>
                
                <div class="mb-3">
                    <strong>Целевая переменная:</strong><br>
                    <code>{{ original_model.target_column }}</code>
                </div>
                
                <div class="mb-3">
                    <strong>Признаки:</strong><br>
                    <small>{{ original_model.feature_columns|length }} колонок</small>
                </div>
                
                {% if original_model.training_time %}
                    <div class="mb-3">
                        <strong>Время обучения:</strong><br>
                        {{ original_model.training_time|floatformat:2 }}с
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">Теги</h6>
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    {% for tag in public_model.get_tags_list %}
                        <a href="{% url 'collaboration:model_list' %}?tag={{ tag }}" 
                           class="badge bg-secondary">
                            {{ tag }}
                        </a>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Автор</h6>
            </div>
            <div class="card-body">
                <div class="text-center">
                    <i class="bi bi-person-circle display-4"></i>
                    <h5 class="mt-2">{{ public_model.author.username }}</h5>
                    <p class="text-muted small">
                        Опубликовано {{ public_model.created_at|date:"d.m.Y" }}
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// AJAX лайк
document.getElementById('like-btn')?.addEventListener('click', async function() {
    const btn = this;
    const modelId = btn.dataset.modelId;
    
    try {
        const response = await fetch(`/community/models/${modelId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        // Обновляем UI
        document.getElementById('likes-count').textContent = data.likes_count;
        document.getElementById('like-text').textContent = data.liked ? 'Убрать лайк' : 'Лайк';
        
        const icon = btn.querySelector('i');
        if (data.liked) {
            icon.classList.remove('bi-heart');
            icon.classList.add('bi-heart-fill');
            btn.classList.add('liked');
        } else {
            icon.classList.remove('bi-heart-fill');
            icon.classList.add('bi-heart');
            btn.classList.remove('liked');
        }
    } catch (error) {
        console.error('Error:', error);
    }
});
</script>
{% endblock %}